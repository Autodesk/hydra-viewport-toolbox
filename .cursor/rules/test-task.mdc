---
description: How to create a unit test with a single frame pass and custom tasks
globs:
  - "test/**/*.cpp"
  - "test/**/*.h"
alwaysApply: true
---

# Creating a Unit Test with a Single Frame Pass and Custom Tasks

This rule explains how to create a unit test that uses a single frame pass with custom tasks like blur, FXAA, or other post-processing effects.

**Important**: Before generating the test, always ask the user which file they want to add the unit test to.

**Important**: When generating the test code, include the user's original prompt as a comment at the beginning of the test function, right after the opening brace. Format it as:
```cpp
// Prompt: <user's original request>
```

## Reference Implementation: `TestFramePasses_MainWithBlur`

The following test serves as the canonical example for single frame pass with custom task testing:

```cpp
HVT_TEST(TestViewportToolbox, TestFramePasses_MainWithBlur)
{
    // Prompt: @test-task blur

    auto context = TestHelpers::CreateTestContext();
    TestHelpers::TestStage stage(context->_backend);

    ASSERT_TRUE(stage.open(context->_sceneFilepath));

    // Main scene Frame Pass.

    auto framePass = TestHelpers::FramePassInstance::CreateInstance(
        "HdStormRendererPlugin", stage.stage(), context->_backend);

    auto& taskManager = framePass.sceneFramePass->GetTaskManager();

    static const float blurValue = 8.0f;

    // Creates & adds the blur custom task.

    {
        // Defines the blur task update function.

        auto fnCommit = [&](hvt::TaskManager::GetTaskValueFn const& fnGetValue,
                            hvt::TaskManager::SetTaskValueFn const& fnSetValue)
        {
            const VtValue value        = fnGetValue(HdTokens->params);
            hvt::BlurTaskParams params = value.Get<hvt::BlurTaskParams>();
            params.blurAmount          = blurValue;
            fnSetValue(HdTokens->params, VtValue(params));
        };

        // Adds the blur task, before the present task.

        const SdfPath& insertPos = taskManager->GetTaskPath(HdxPrimitiveTokens->presentTask);

        taskManager->AddTask<hvt::BlurTask>(hvt::BlurTask::GetToken(), hvt::BlurTaskParams(),
            fnCommit, insertPos, hvt::TaskManager::InsertionOrder::insertBefore);
    }

    // Render 10 frames.
    int frameCount = 10;

    auto render = [&]()
    {
        TestHelpers::RenderSecondFramePass(framePass, context->width(), context->height(),
            context->presentationEnabled(), stage, {}, true, TestHelpers::ColorDarkGrey, true);

        // Force GPU sync. Wait for all GPU commands to complete before proceeding.
        // This ensures render operations are fully finished before the next frame
        // or validation step, preventing race conditions and ensuring consistent results.
        context->_backend->waitForGPUIdle();

        return --frameCount > 0;
    };

    // Run the render loop.
    context->run(render, framePass.sceneFramePass.get());

    const std::string computedImagePath = TestHelpers::getComputedImagePath();
    ASSERT_TRUE(context->validateImages(computedImagePath, TestHelpers::gTestNames.fixtureName));
}
```

## Reference Implementation: `TestFramePasses_MainWithFxaa`

Another example using FXAA anti-aliasing task:

```cpp
HVT_TEST(TestViewportToolbox, TestFramePasses_MainWithFxaa)
{
    // Prompt: @test-task fxaa

    auto context = TestHelpers::CreateTestContext();
    TestHelpers::TestStage stage(context->_backend);

    ASSERT_TRUE(stage.open(context->_sceneFilepath));

    // Main scene Frame Pass.

    auto framePass = TestHelpers::FramePassInstance::CreateInstance(
        "HdStormRendererPlugin", stage.stage(), context->_backend);

    auto& taskManager = framePass.sceneFramePass->GetTaskManager();

    // Creates & adds the fxaa custom task.

    {
        // Defines the anti-aliasing task update function.

        auto fnCommit = [&](hvt::TaskManager::GetTaskValueFn const& fnGetValue,
                            hvt::TaskManager::SetTaskValueFn const& fnSetValue)
        {
            auto framing = framePass.sceneFramePass->params().renderParams.framing;

            const VtValue value        = fnGetValue(HdTokens->params);
            hvt::FXAATaskParams params = value.Get<hvt::FXAATaskParams>();
            params.pixelToUV           = GfVec2f(
                1.0f / framing.dataWindow.GetWidth(), 1.0f / framing.dataWindow.GetHeight());
            fnSetValue(HdTokens->params, VtValue(params));
        };

        // Adds the FXAA anti-aliasing task into the task list, after color correction.

        const SdfPath& insertPos = taskManager->GetTaskPath(HdxPrimitiveTokens->colorCorrectionTask);

        taskManager->AddTask<hvt::FXAATask>(hvt::FXAATask::GetToken(), hvt::FXAATaskParams(),
            fnCommit, insertPos, hvt::TaskManager::InsertionOrder::insertAfter);
    }

    // Render 10 frames.
    int frameCount = 10;

    auto render = [&]()
    {
        TestHelpers::RenderSecondFramePass(framePass, context->width(), context->height(),
            context->presentationEnabled(), stage, {}, true, TestHelpers::ColorDarkGrey, true);

        // Force GPU sync. Wait for all GPU commands to complete before proceeding.
        // This ensures render operations are fully finished before the next frame
        // or validation step, preventing race conditions and ensuring consistent results.
        context->_backend->waitForGPUIdle();

        return --frameCount > 0;
    };

    // Run the render loop.
    context->run(render, framePass.sceneFramePass.get());

    const std::string computedImagePath = TestHelpers::getComputedImagePath();
    ASSERT_TRUE(context->validateImages(computedImagePath, TestHelpers::gTestNames.fixtureName));
}
```

## Step-by-Step Guide

### 1. Test Declaration

Declare the test using the `HVT_TEST` macro:

```cpp
HVT_TEST(TestViewportToolbox, TestFramePasses_<task_name>)
```

### 2. Setup Test Context and Stage

```cpp
auto context = TestHelpers::CreateTestContext();
TestHelpers::TestStage stage(context->_backend);

ASSERT_TRUE(stage.open(context->_sceneFilepath));
```

### 3. Create Frame Pass and Get Task Manager

```cpp
auto framePass = TestHelpers::FramePassInstance::CreateInstance(
    "HdStormRendererPlugin", stage.stage(), context->_backend);

auto& taskManager = framePass.sceneFramePass->GetTaskManager();
```

### 4. Add Custom Task

Create a commit function and add the task to the task manager:

```cpp
{
    // Defines the task update function.

    auto fnCommit = [&](hvt::TaskManager::GetTaskValueFn const& fnGetValue,
                        hvt::TaskManager::SetTaskValueFn const& fnSetValue)
    {
        const VtValue value = fnGetValue(HdTokens->params);
        // Get and modify task params...
        fnSetValue(HdTokens->params, VtValue(params));
    };

    // Adds the task at the desired position.

    const SdfPath& insertPos = taskManager->GetTaskPath(HdxPrimitiveTokens->presentTask);

    taskManager->AddTask<YourTask>(YourTask::GetToken(), YourTaskParams(),
        fnCommit, insertPos, hvt::TaskManager::InsertionOrder::insertBefore);
}
```

### 5. Configure Render Loop

```cpp
int frameCount = 10;

auto render = [&]()
{
    TestHelpers::RenderSecondFramePass(framePass, context->width(), context->height(),
        context->presentationEnabled(), stage, {}, true, TestHelpers::ColorDarkGrey, true);

    context->_backend->waitForGPUIdle();

    return --frameCount > 0;
};
```

### 6. Run Render Loop and Validate

```cpp
context->run(render, framePass.sceneFramePass.get());

const std::string computedImagePath = TestHelpers::getComputedImagePath();
ASSERT_TRUE(context->validateImages(computedImagePath, TestHelpers::gTestNames.fixtureName));
```

## Available Tasks

| Task | Token | Insert Position | Description |
|------|-------|-----------------|-------------|
| `hvt::BlurTask` | `hvt::BlurTask::GetToken()` | Before `presentTask` | Applies blur effect |
| `hvt::FXAATask` | `hvt::FXAATask::GetToken()` | After `colorCorrectionTask` | Anti-aliasing effect |

## Task Insertion Positions

Common task positions in the task manager:

| Token | Description |
|-------|-------------|
| `HdxPrimitiveTokens->presentTask` | Final presentation task |
| `HdxPrimitiveTokens->colorCorrectionTask` | Color correction task |
| `HdxPrimitiveTokens->renderTask` | Main render task |

## Key Points

1. **Task Manager Access**: Get the task manager from the frame pass using `framePass.sceneFramePass->GetTaskManager()`.

2. **Task Insertion Order**: Use `InsertionOrder::insertBefore` or `InsertionOrder::insertAfter` to control task execution order.

3. **Commit Function**: The `fnCommit` lambda is called each frame to update task parameters.

4. **GPU Synchronization**: Always call `context->_backend->waitForGPUIdle()` before validation.

5. **Multiple Render Iterations**: Render multiple frames (typically 10) to ensure consistent results.

## Required Includes

```cpp
#include "composeTaskHelpers.h"

#include <RenderingFramework/TestContextCreator.h>

#include <hvt/engine/framePassUtils.h>
#include <hvt/engine/viewport.h>
#include <hvt/engine/viewportEngine.h>
#include <hvt/engine/taskUtils.h>
#include <hvt/tasks/blurTask.h>
#include <hvt/tasks/fxaaTask.h>
#include <hvt/tasks/resources.h>

#include <gtest/gtest.h>

#include <pxr/pxr.h>

PXR_NAMESPACE_USING_DIRECTIVE
```
